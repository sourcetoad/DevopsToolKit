# Last two digits of port number are the MAJOR.MINOR of the data source
# Everything ahead of the last two digits are standard for the given service
#
# Network name is st-{service name}-{service MAJOR.MINOR}
---
services:
  nginxproxy:
# Enable nginx debug and increase output verbosity
#    command: [nginx-debug, '-g', 'daemon off;']
    image: jwilder/nginx-proxy
    container_name: sourcetoad_nginx_proxy
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./proxy_increase.conf:/etc/nginx/proxy.conf
    networks:
      - st-internal
  mariadb1108:
    image: mariadb:11.8
    container_name: sourcetoad_mariadb1108
    ports:
      - "33118:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_USER=mariadb_user
      - MYSQL_PASSWORD=mariadb_pass
    networks:
      - st-internal
  mariadb1104:
    image: mariadb:11.4
    container_name: sourcetoad_mariadb1104
    ports:
      - "33114:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_USER=mariadb_user
      - MYSQL_PASSWORD=mariadb_pass
    networks:
      - st-internal
  mariadb1011:
    image: mariadb:10.11
    container_name: sourcetoad_mariadb1011
    ports:
      - "33111:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_USER=mariadb_user
      - MYSQL_PASSWORD=mariadb_pass
    networks:
      - st-internal
  rustfs:
    container_name: sourcetoad_rustfs
    image: rustfs/rustfs:1.0.0-alpha.79
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - RUSTFS_VOLUMES=/data
      - RUSTFS_ADDRESS=0.0.0.0:9000
      - RUSTFS_CONSOLE_ADDRESS=0.0.0.0:9001
      - RUSTFS_CONSOLE_ENABLE=true
      - RUSTFS_EXTERNAL_ADDRESS=:9000
      - RUSTFS_CORS_ALLOWED_ORIGINS=*
      - RUSTFS_CONSOLE_CORS_ALLOWED_ORIGINS=*
      - RUSTFS_LOG_LEVEL=info
    volumes:
      - ./storage/rustfs:/data
    networks:
      st-internal:
        aliases:
          - s3.docker
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://127.0.0.1:9000/health && curl -f http://127.0.0.1:9001/health"]
      interval: 5m
      timeout: 10s
      retries: 3
      start_period: 40s
networks:
  st-internal:
    external: true
    name: st-internal
